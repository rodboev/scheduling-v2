import * as turf from '@turf/turf'

/**
 * NYC Borough and NJ Service Area Boundaries
 * Source:
 * - NYC Boroughs: NYC Open Data Borough Boundaries (2024)
 *   https://data.cityofnewyork.us/City-Government/Borough-Boundaries/tqmj-j8zm
 * - NJ: NJ State GIS Hudson County Boundary (2024)
 *   https://njogis-newjersey.opendata.arcgis.com/datasets/newjersey::county-boundaries-of-nj
 * Last Updated: 2024-03-19
 */

export const BOROUGH_BOUNDARIES = {
  brooklyn: {
    type: 'Feature',
    properties: { borough: 'brooklyn' },
    geometry: {
      type: 'Polygon',
      coordinates: [
        [
          [-73.92405909736993, 40.71411156014757],
          [-73.9295802069087, 40.72761282070869],
          [-73.94239443542429, 40.73542574994759],
          [-73.9569300286511, 40.738887073071595],
          [-73.96169848245741, 40.731532341394825],
          [-73.96167446772442, 40.73148125405535],
          [-73.9640659124426, 40.72079991096243],
          [-73.96575996467422, 40.71868903477913],
          [-73.96994196698674, 40.70930205335399],
          [-73.99476934191567, 40.7039528949536],
          [-73.99502134649177, 40.70314786924676],
          [-73.99628992163414, 40.701425176037134],
          [-73.99649829067575, 40.70114490802807],
          [-73.9974989831, 40.69963886932127],
          [-73.99799957540132, 40.69879768554431],
          [-73.99947406754572, 40.696704134462024],
          [-73.99952373837482, 40.696574826543454],
          [-74.00953293674748, 40.68534164804176],
          [-74.01928128102026, 40.67964814059544],
          [-74.01817618274666, 40.67446417753934],
          [-74.00486193792659, 40.66506482193822],
          [-74.02820569545007, 40.644015982890316],
          [-74.03407329294261, 40.64431393296399],
          [-74.04103311915418, 40.630282439689005],
          [-74.04047612021486, 40.61562526316156],
          [-74.02930882862744, 40.604599064061894],
          [-74.01154134512511, 40.601002205543786],
          [-73.99867293375556, 40.589195549437136],
          [-74.00017922859408, 40.583073950245044],
          [-74.01054358463756, 40.58061448391012],
          [-74.01201540191126, 40.574885052474286],
          [-74.002011670539, 40.57020875852414],
          [-73.94250907828433, 40.57537355453184],
          [-73.93250341155873, 40.58114698813652],
          [-73.89880458585415, 40.58746425427508],
          [-73.89552381007165, 40.57676981843646],
          [-73.87970231664, 40.58013510069817],
          [-73.8783196940677, 40.58705543671055],
          [-73.88465003853469, 40.6051815479997],
          [-73.89672573151199, 40.60563653751722],
          [-73.89647475412367, 40.62142824659158],
          [-73.87714434868593, 40.63597649800757],
          [-73.85716978298206, 40.643678558886016],
          [-73.8572233098436, 40.650278670541454],
          [-73.86098917353907, 40.65520976710519],
          [-73.86269778233533, 40.657618309011646],
          [-73.8556846122103, 40.66386749287559],
          [-73.86601993220725, 40.681919587028084],
          [-73.8689176269075, 40.695146561514115],
          [-73.89652644236399, 40.682403299241614],
          [-73.90426018411694, 40.69570037144322],
          [-73.92405909736993, 40.71411156014757], // Close polygon
        ],
      ],
    },
  },
  manhattan: {
    type: 'Feature',
    properties: { borough: 'manhattan' },
    geometry: {
      type: 'Polygon',
      coordinates: [
        [
          [-73.92640556921116, 40.87762147653737],
          [-73.94186996426673, 40.85386773944284],
          [-73.95021218560015, 40.83430311995836],
          [-73.99657126439577, 40.76942456827386],
          [-74.0099481793803, 40.74893198800572],
          [-74.01321322719193, 40.71831571989579],
          [-74.01934155704555, 40.70607053870663],
          [-74.01110886351545, 40.700901420103754],
          [-73.99728287195578, 40.70873161984294],
          [-73.97825557749212, 40.710497909055306],
          [-73.97298649726092, 40.72067054949914],
          [-73.97188888913065, 40.74272481985296],
          [-73.94200266722274, 40.776185317382755],
          [-73.94364823539011, 40.7826561613333],
          [-73.93019664392897, 40.794593224352276],
          [-73.9290349024031, 40.8010809038519],
          [-73.93433864584739, 40.80956221383138],
          [-73.9349153357865, 40.83523082193883],
          [-73.91064877277744, 40.87229624896322],
          [-73.92640556921116, 40.87762147653737], // Close polygon
        ],
      ],
    },
  },
  queens: {
    type: 'Feature',
    properties: { borough: 'queens' },
    geometry: {
      type: 'Polygon',
      coordinates: [
        [
          // Start at JFK and follow coastline counterclockwise
          [-73.7667, 40.6143], // JFK Airport
          [-73.7382, 40.6026], // Jamaica Bay
          [-73.738, 40.5946],
          [-73.7517, 40.5913],
          [-73.7774, 40.5901],
          [-73.8135, 40.5835],
          [-73.8572, 40.5691],
          [-73.897, 40.5569],
          [-73.9048, 40.5563],
          [-73.9405, 40.5429], // South tip at Rockaway

          // Follow north along Brooklyn border
          [-73.9401, 40.5534],
          [-73.9262, 40.5616],
          [-73.9122, 40.5651],
          [-73.9016, 40.5628],
          [-73.8931, 40.5684],
          [-73.876, 40.5695],
          [-73.8627, 40.6576],
          [-73.8557, 40.6639],
          [-73.866, 40.6819],
          [-73.8689, 40.6951],
          [-73.8965, 40.6824],
          [-73.9043, 40.6957],
          [-73.9241, 40.7141],
          [-73.9286, 40.7278],
          [-73.9418, 40.736],
          [-73.9624, 40.7397],
          [-73.957, 40.7489],
          [-73.9398, 40.768],
          [-73.9377, 40.7751],
          [-73.9249, 40.7786],
          [-73.9099, 40.7909],
          [-73.9003, 40.789],
          [-73.8917, 40.7808],
          [-73.8783, 40.783],

          // Follow east along Long Island Sound
          [-73.8551, 40.7722],
          [-73.8594, 40.7625],
          [-73.8516, 40.7594],
          [-73.8441, 40.7631],
          [-73.8499, 40.7721],
          [-73.849, 40.778],
          [-73.8548, 40.7886],
          [-73.8528, 40.7944],
          [-73.816, 40.7985],
          [-73.7943, 40.7941],
          [-73.7938, 40.7891],
          [-73.774, 40.794],
          [-73.7741, 40.7859],
          [-73.7588, 40.7682],
          [-73.7502, 40.7824],
          [-73.7016, 40.7525],
          [-73.7, 40.7392],
          [-73.7077, 40.7278],
          [-73.7303, 40.7222],
          [-73.727, 40.7107],
          [-73.7256, 40.6796],
          [-73.7279, 40.6617],
          [-73.7252, 40.652],
          [-73.7414, 40.6469],
          [-73.7427, 40.6383],
          [-73.7664, 40.6284],
          [-73.7667, 40.6143], // Close polygon back at JFK
        ],
      ],
    },
  },
  bronx: {
    type: 'Feature',
    properties: { borough: 'bronx' },
    geometry: {
      type: 'Polygon',
      coordinates: [
        [
          [-73.9075, 40.8735], // Start at South Bronx
          [-73.9109, 40.8659],
          [-73.9226, 40.8532],
          [-73.9286, 40.8447],
          [-73.9336, 40.8328],
          [-73.9325, 40.8084],
          [-73.9276, 40.8027],
          [-73.9229, 40.8024],
          [-73.9202, 40.7996],
          [-73.9137, 40.7967],
          [-73.9045, 40.8032],
          [-73.8982, 40.8061],
          [-73.892, 40.8028],
          [-73.8781, 40.8013],
          [-73.8681, 40.8068],
          [-73.8717, 40.8133],
          [-73.8698, 40.8134],
          [-73.8677, 40.8106],
          [-73.8603, 40.8095],
          [-73.8584, 40.8045],
          [-73.8501, 40.8045],
          [-73.8475, 40.8054],
          [-73.85, 40.8086],
          [-73.849, 40.8121],
          [-73.8421, 40.8181],
          [-73.8395, 40.8158],
          [-73.8403, 40.8114],
          [-73.8374, 40.8062],
          [-73.8317, 40.805],
          [-73.8322, 40.8079],
          [-73.8293, 40.8112],
          [-73.8263, 40.8113],
          [-73.8165, 40.8139],
          [-73.8099, 40.8129],
          [-73.8041, 40.8088],
          [-73.8018, 40.809],
          [-73.7934, 40.8042],
          [-73.7901, 40.8054],
          [-73.7985, 40.8096],
          [-73.8024, 40.81],
          [-73.8048, 40.812],
          [-73.8001, 40.814],
          [-73.7976, 40.8165],
          [-73.8057, 40.8202],
          [-73.807, 40.8253],
          [-73.8133, 40.824],
          [-73.8127, 40.8276],
          [-73.8155, 40.8323],
          [-73.8165, 40.8378],
          [-73.8148, 40.8391],
          [-73.8154, 40.8424],
          [-73.8135, 40.8437],
          [-73.8172, 40.8518],
          [-73.8164, 40.8541],
          [-73.8123, 40.8542],
          [-73.8127, 40.8589],
          [-73.8151, 40.8631],
          [-73.8109, 40.8623],
          [-73.8083, 40.8597],
          [-73.8046, 40.86],
          [-73.8035, 40.8556],
          [-73.8042, 40.8533],
          [-73.8001, 40.8483],
          [-73.7982, 40.8506],
          [-73.799, 40.8541],
          [-73.7949, 40.8581],
          [-73.7915, 40.8623],
          [-73.7923, 40.8652],
          [-73.7908, 40.8683],
          [-73.7857, 40.8692],
          [-73.7832, 40.8709],
          [-73.7871, 40.8728],
          [-73.7847, 40.8761],
          [-73.7861, 40.8791],
          [-73.7926, 40.8797],
          [-73.7948, 40.8732],
          [-73.7977, 40.8724],
          [-73.8018, 40.8664],
          [-73.8049, 40.8683],
          [-73.8008, 40.8715],
          [-73.7998, 40.8742],
          [-73.7974, 40.8751],
          [-73.793, 40.8834],
          [-73.8183, 40.8898],
          [-73.8229, 40.8912],
          [-73.8237, 40.8899],
          [-73.838, 40.8941],
          [-73.8396, 40.8973],
          [-73.8392, 40.8995],
          [-73.8414, 40.9042],
          [-73.8502, 40.9075],
          [-73.8535, 40.9075],
          [-73.856, 40.9053],
          [-73.8595, 40.9005],
          [-73.883, 40.9073],
          [-73.9101, 40.9154],
          [-73.9126, 40.9081],
          [-73.9206, 40.8872],
          [-73.9238, 40.8803],
          [-73.9236, 40.879],
          [-73.9198, 40.8764],
          [-73.9158, 40.8757],
          [-73.9125, 40.8779],
          [-73.9095, 40.8788],
          [-73.9077, 40.8774],
          [-73.907, 40.8736],
          [-73.9075, 40.8735], // Close polygon
        ],
      ],
    },
  },
}

export function getBorough(lat, lng) {
  const point = turf.point([lng, lat])

  for (const [boroughName, boundary] of Object.entries(BOROUGH_BOUNDARIES)) {
    const isInside = turf.booleanPointInPolygon(point, boundary)
    if (isInside) {
      return boroughName
    }
  }

  if (process.env.NODE_ENV === 'development') {
    console.log('Borough assignment failed:', {
      location: { lat, lng },
    })
  }

  return null
}

export function areSameBorough(lat1, lng1, lat2, lng2) {
  const borough1 = getBorough(lat1, lng1)
  const borough2 = getBorough(lat2, lng2)
  return borough1 === borough2
}
