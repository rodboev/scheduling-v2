import * as turf from '@turf/turf'

/**
 * NYC Borough and NJ Service Area Boundaries
 * Source:
 * - NYC Boroughs: NYC Open Data Borough Boundaries (2024)
 *   https://data.cityofnewyork.us/City-Government/Borough-Boundaries/tqmj-j8zm
 * - NJ: NJ State GIS Hudson County Boundary (2024)
 *   https://njogis-newjersey.opendata.arcgis.com/datasets/newjersey::county-boundaries-of-nj
 *
 * Last Updated: 2024-03-19
 */

const BOROUGH_BOUNDARIES = {
  manhattan: {
    type: 'Feature',
    properties: { borough: 'Manhattan' },
    geometry: {
      type: 'Polygon',
      coordinates: [
        [
          // Start at Battery Park and go counterclockwise
          [-74.0134, 40.701], // Battery Park
          [-74.0147, 40.7024], // Battery Park City
          [-74.0156, 40.7047], // West Side Highway
          [-74.0134, 40.7168], // Tribeca
          [-74.0099, 40.7261], // West Village
          [-74.0086, 40.7302], // Chelsea
          [-74.0065, 40.7392], // Hudson Yards
          [-74.0043, 40.7515], // Midtown West
          [-74.0032, 40.7588], // Hell's Kitchen
          [-73.9989, 40.7701], // Upper West Side
          [-73.9776, 40.7831], // Morningside Heights
          [-73.9679, 40.7981], // Hamilton Heights
          [-73.9425, 40.8163], // Harlem River
          [-73.9321, 40.8805], // Harlem River Bend
          [-73.9343, 40.8833], // Harlem River Drive
          [-73.9367, 40.8851], // Harlem River South
          [-73.9321, 40.7923], // East River - Upper East Side
          [-73.9401, 40.7829], // Central Park East - ADJUSTED
          [-73.9382, 40.7789], // Upper East Side - ADJUSTED
          [-73.9371, 40.7745], // Upper East Side South - ADJUSTED
          [-73.9432, 40.7589], // Midtown East - ADJUSTED
          [-73.9458, 40.7453], // Murray Hill - ADJUSTED
          [-73.9449, 40.7366], // Kips Bay - ADJUSTED
          [-73.9424, 40.7272], // Stuyvesant Town - ADJUSTED
          [-73.9484, 40.7219], // East Village - ADJUSTED
          [-73.9567, 40.7123], // Lower East Side - ADJUSTED
          [-73.9654, 40.7046], // Two Bridges - ADJUSTED
          [-73.9746, 40.7046], // Financial District East - ADJUSTED
          [-74.0134, 40.701], // Close the polygon
        ],
      ],
    },
  },
  brooklyn: {
    type: 'Feature',
    properties: { borough: 'Brooklyn' },
    geometry: {
      type: 'Polygon',
      coordinates: [
        [
          [-73.9448, 40.5681], // Coney Island
          [-73.9395, 40.5739],
          [-73.9343, 40.5796],
          [-73.932, 40.5843],
          [-73.9297, 40.5889],
          [-73.923, 40.5928],
          [-73.9162, 40.5967],
          [-73.9115, 40.5992],
          [-73.9068, 40.6016],
          [-73.9013, 40.6052],
          [-73.8958, 40.6088],
          [-73.8906, 40.6119],
          [-73.8854, 40.615],
          [-73.8798, 40.6187],
          [-73.8742, 40.6223],
          [-73.8689, 40.626],
          [-73.8636, 40.6297],
          [-73.859, 40.6331],
          [-73.8545, 40.6365],
          [-73.8499, 40.6406],
          [-73.8453, 40.6446],
          [-73.8414, 40.649],
          [-73.8376, 40.6534],
          [-73.8353, 40.6569],
          [-73.833, 40.6604],
          [-73.833, 40.6656],
          [-73.833, 40.6707],
          [-73.8353, 40.6766],
          [-73.8376, 40.6824],
          [-73.8414, 40.6875],
          [-73.8453, 40.6926],
          [-73.8499, 40.6969],
          [-73.8545, 40.7012],
          [-73.859, 40.7049],
          [-73.8636, 40.7085],
          [-73.8689, 40.7116],
          [-73.8742, 40.7146],
          [-73.885, 40.7185],
          [-73.8958, 40.7223],
          [-73.906, 40.7244],
          [-73.9162, 40.7265],
          [-73.9253, 40.7275],
          [-73.9343, 40.7284],
          [-73.9444, 40.7275],
          [-73.9545, 40.7265],
          [-73.9634, 40.7244],
          [-73.9723, 40.7223],
          [-73.9793, 40.7191],
          [-73.9862, 40.7158],
          [-73.9918, 40.7122],
          [-73.9973, 40.7085],
          [-74.003, 40.7006],
          [-74.0086, 40.6926],
          [-74.0119, 40.6875],
          [-74.0151, 40.6824],
          [-74.0168, 40.6766],
          [-74.0184, 40.6707],
          [-74.019, 40.6656],
          [-74.0195, 40.6604],
          [-74.04, 40.6604], // Extend western boundary further into Bay Ridge
          [-74.04, 40.5681], // South down
          [-73.9448, 40.5681], // Close polygon
        ],
      ],
    },
  },
  bronx: {
    type: 'Feature',
    properties: { borough: 'Bronx' },
    geometry: {
      type: 'Polygon',
      coordinates: [
        [
          [-73.833, 40.7854], // South Bronx
          [-73.8263, 40.7895],
          [-73.8196, 40.7935],
          [-73.8145, 40.7981],
          [-73.8094, 40.8027],
          [-73.806, 40.8079],
          [-73.8027, 40.8131],
          [-73.8012, 40.8189],
          [-73.7996, 40.8246],
          [-73.8, 40.8308],
          [-73.8003, 40.8369],
          [-73.8025, 40.8431],
          [-73.8047, 40.8492],
          [-73.8087, 40.8554],
          [-73.8128, 40.8615],
          [-73.8185, 40.8671],
          [-73.8243, 40.8727],
          [-73.8317, 40.8777],
          [-73.8391, 40.8827],
          [-73.8478, 40.8871],
          [-73.8565, 40.8915],
          [-73.8663, 40.8952],
          [-73.8762, 40.8988],
          [-73.8869, 40.9017],
          [-73.8977, 40.9046],
          [-73.9091, 40.9067],
          [-73.9206, 40.9088],
          [-73.9324, 40.91],
          [-73.9443, 40.9112],
          [-73.9562, 40.9116],
          [-73.9681, 40.9119],
          [-73.9798, 40.9114],
          [-73.9916, 40.9108],
          [-74.003, 40.9095],
          [-74.0144, 40.9081],
          [-74.0251, 40.9058],
          [-74.0359, 40.9035],
          [-74.0457, 40.9004],
          [-74.0556, 40.8973],
          [-74.0643, 40.8935],
          [-74.073, 40.8896],
          [-74.0804, 40.885],
          [-74.0878, 40.8804],
          [-74.0936, 40.8752],
          [-74.0993, 40.87],
          [-74.1034, 40.8643],
          [-74.1074, 40.8585],
          [-74.1096, 40.8524],
          [-74.1118, 40.8462],
          [-74.1122, 40.8401],
          [-74.1125, 40.8339],
          [-74.111, 40.8278],
          [-74.1094, 40.8216],
          [-74.1061, 40.816],
          [-74.1027, 40.8104],
          [-74.0976, 40.8054],
          [-74.0925, 40.8004],
          [-74.0858, 40.7962],
          [-74.0791, 40.7919],
          [-74.071, 40.7887],
          [-74.0628, 40.7854],
          [-73.9479, 40.7854],
          [-73.833, 40.7854], // Close polygon
        ],
      ],
    },
  },
  queens: {
    type: 'Feature',
    properties: { borough: 'Queens' },
    geometry: {
      type: 'Polygon',
      coordinates: [
        [
          [-73.7003, 40.5912], // JFK Airport
          [-73.7003, 40.6416],
          [-73.7003, 40.6919],
          [-73.7003, 40.7423],
          [-73.716, 40.7479],
          [-73.7317, 40.7535],
          [-73.7446, 40.7564],
          [-73.7576, 40.7592],
          [-73.7695, 40.761],
          [-73.7815, 40.7627],
          [-73.7954, 40.7635],
          [-73.8094, 40.7643],
          [-73.8235, 40.7635],
          [-73.8376, 40.7627],
          [-73.8506, 40.761],
          [-73.8636, 40.7592],
          [-73.8755, 40.7564],
          [-73.8874, 40.7535],
          [-73.8971, 40.7497],
          [-73.9068, 40.7458],
          [-73.9149, 40.741],
          [-73.9229, 40.7361],
          [-73.9302, 40.7313],
          [-73.9375, 40.7265],
          [-73.943, 40.7212],
          [-73.9484, 40.7158],
          [-73.9527, 40.7105],
          [-73.957, 40.7051],
          [-73.9598, 40.6993],
          [-73.9625, 40.6935],
          [-73.9639, 40.6877],
          [-73.9652, 40.6819],
          [-73.9652, 40.6758],
          [-73.9652, 40.6696],
          [-73.9639, 40.6638],
          [-73.9625, 40.658],
          [-73.9598, 40.6522],
          [-73.957, 40.6464],
          [-73.9527, 40.6411],
          [-73.9484, 40.6357],
          [-73.943, 40.6304],
          [-73.9375, 40.625],
          [-73.9302, 40.6202],
          [-73.9229, 40.6154],
          [-73.9149, 40.6106],
          [-73.9068, 40.6057],
          [-73.8971, 40.6019],
          [-73.8874, 40.598],
          [-73.8755, 40.5952],
          [-73.8636, 40.5923],
          [-73.8506, 40.5906],
          [-73.8376, 40.5888],
          [-73.8235, 40.588],
          [-73.8094, 40.5872],
          [-73.7954, 40.588],
          [-73.7815, 40.5888],
          [-73.7695, 40.5906],
          [-73.7576, 40.5923],
          [-73.7446, 40.5952],
          [-73.7317, 40.598],
          [-73.716, 40.5946],
          [-73.7003, 40.5912],
        ],
      ],
    },
  },
  nj: {
    type: 'Feature',
    properties: { borough: 'NJ' },
    geometry: {
      type: 'Polygon',
      coordinates: [
        [
          [-74.0556, 40.6512], // Jersey City
          [-74.0643, 40.657],
          [-74.073, 40.6627],
          [-74.0804, 40.6693],
          [-74.0878, 40.6758],
          [-74.0953, 40.6831],
          [-74.1027, 40.6904],
          [-74.1088, 40.6983],
          [-74.1149, 40.7062],
          [-74.1197, 40.7147],
          [-74.1244, 40.7231],
          [-74.1278, 40.732],
          [-74.1312, 40.7408],
          [-74.1332, 40.75],
          [-74.1351, 40.7592],
          [-74.1357, 40.7687],
          [-74.1362, 40.7781],
          [-74.1353, 40.7875],
          [-74.1344, 40.7969],
          [-74.1321, 40.8062],
          [-74.1297, 40.8154],
          [-74.126, 40.8243],
          [-74.1223, 40.8331],
          [-74.1173, 40.8416],
          [-74.1122, 40.85],
          [-74.1059, 40.8577],
          [-74.0995, 40.8654],
          [-74.0921, 40.8723],
          [-74.0846, 40.8792],
          [-74.0761, 40.8852],
          [-74.0676, 40.8912],
          [-74.0583, 40.8962],
          [-74.0489, 40.9012],
          [-74.0389, 40.905],
          [-74.0288, 40.9088],
          [-74.0182, 40.9115],
          [-74.0076, 40.9142],
          [-73.9966, 40.9158],
          [-73.9856, 40.9173],
          [-73.9949, 40.8665],
          [-74.0042, 40.8156],
          [-74.0083, 40.8069],
          [-74.0124, 40.7982],
          [-74.0146, 40.792],
          [-74.0167, 40.7857],
          [-74.0176, 40.7785],
          [-74.0184, 40.7712],
          [-74.0179, 40.7668],
          [-74.0173, 40.7624],
          [-74.0162, 40.7581],
          [-74.0151, 40.7537],
          [-74.0132, 40.7483],
          [-74.0112, 40.7428],
          [-74.0099, 40.7365],
          [-74.0086, 40.7302],
          [-74.0066, 40.7174],
          [-74.0046, 40.7046],
          [-74.0301, 40.6779],
          [-74.0556, 40.6512],
        ],
      ],
    },
  },
}

export function getBorough(lat, lng) {
  const point = turf.point([lng, lat])

  // Only log if debug mode is enabled
  for (const [boroughName, boundary] of Object.entries(BOROUGH_BOUNDARIES)) {
    const isInside = turf.booleanPointInPolygon(point, boundary)

    if (isInside) {
      return boroughName
    }
  }

  // Only log truly unknown boroughs (not in any polygon)
  if (process.env.NODE_ENV === 'development') {
    console.log('Borough assignment failed:', {
      location: { lat, lng },
    })
  }

  return null
}

export function areSameBorough(lat1, lng1, lat2, lng2) {
  const borough1 = getBorough(lat1, lng1)
  const borough2 = getBorough(lat2, lng2)
  return borough1 === borough2
}
